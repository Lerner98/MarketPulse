# Pre-commit hooks for MarketPulse
# Install: pip install pre-commit && pre-commit install
# See https://pre-commit.com for more information

repos:
  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: check-merge-conflict
      - id: detect-private-key
      - id: check-case-conflict
      - id: mixed-line-ending

  # Python formatting with Black
  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
        language_version: python3.11
        files: ^backend/

  # Python linting with Flake8
  - repo: https://github.com/pycqa/flake8
    rev: 6.0.0
    hooks:
      - id: flake8
        args: ['--max-line-length=88', '--extend-ignore=E203,W503']
        files: ^backend/

  # Secret scanning with Gitleaks
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.16.1
    hooks:
      - id: gitleaks

  # Frontend formatting with Prettier
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v3.0.0
    hooks:
      - id: prettier
        files: \.(ts|tsx|js|jsx|json|css|md|yml|yaml)$
        exclude: ^(package-lock\.json|backend/)

  # Local hooks (project-specific)
  - repo: local
    hooks:
      # Backend fast unit tests
      - id: pytest-fast
        name: Fast backend unit tests
        entry: bash -c 'if git diff --cached --name-only | grep -q "^backend/"; then cd backend && pytest tests/unit -x --tb=short -q; fi'
        language: system
        pass_filenames: false
        stages: [commit]
        verbose: true

      # Frontend fast tests
      - id: vitest-fast
        name: Fast frontend unit tests
        entry: bash -c 'if git diff --cached --name-only | grep -q "^frontend/src/"; then cd frontend && npm test -- --run --reporter=basic; fi'
        language: system
        pass_filenames: false
        stages: [commit]
        verbose: true

      # Check for debug statements
      - id: no-debug-statements
        name: Check for debug statements (console.log, debugger, pdb)
        entry: bash -c 'if git diff --cached | grep -E "^\+.*(console\.log|console\.debug|debugger|pdb\.set_trace|breakpoint\(\)|print\(.*#\s*DEBUG)"; then echo "❌ Debug statements found! Remove before committing."; exit 1; fi'
        language: system
        pass_filenames: false
        stages: [commit]

      # Check for TODO/FIXME without issue reference
      - id: check-todos
        name: Check TODO/FIXME have issue references
        entry: bash -c 'if git diff --cached | grep -E "^\+.*(TODO|FIXME)" | grep -v -E "(TODO\(#[0-9]+\)|FIXME\(#[0-9]+\)|TODO: Phase)"; then echo "⚠️  TODO/FIXME found without issue reference. Use TODO(#123) or FIXME(#456)"; exit 0; fi'
        language: system
        pass_filenames: false
        stages: [commit]
        verbose: true

      # TypeScript type check (frontend)
      - id: tsc-check
        name: TypeScript type check
        entry: bash -c 'if git diff --cached --name-only | grep -q "^frontend/.*\.tsx\?$"; then cd frontend && npx tsc --noEmit; fi'
        language: system
        pass_filenames: false
        stages: [commit]
        verbose: true

      # Check package.json and package-lock.json are in sync
      - id: npm-sync-check
        name: Check npm package.json and package-lock.json are in sync
        entry: bash -c 'if git diff --cached --name-only | grep -q "^frontend/package\.json$"; then if ! git diff --cached --name-only | grep -q "^frontend/package-lock\.json$"; then echo "❌ package.json changed but package-lock.json did not. Run: cd frontend && npm install"; exit 1; fi; fi'
        language: system
        pass_filenames: false
        stages: [commit]
